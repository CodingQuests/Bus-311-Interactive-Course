<!-- FILE: chapters/ch13.html (Dark Theme • Capital Budgeting + Speed Challenge Game) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chapter 13 · Planning for Capital Investments</title>
<link rel="stylesheet" href="../assets/style.css"/>
<style>
  :root{
    --bg:#0b1220;--surface:#0f1629;--card:#121a31;--ink:#e6eaf2;--muted:#9aa6bf;
    --line:#1e2a44;--accent:#8ab4ff;--accent-2:#a78bfa;--success:#34d399;--danger:#f87171;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
    font:16px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:center;gap:.7rem}.dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2))}
  .nav a{color:var(--muted);text-decoration:none;margin-left:.75rem}.nav a.active{color:var(--ink);font-weight:600}
  .container{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 58px)}
  .sidebar{background:var(--surface);border-right:1px solid var(--line);padding:12px}
  .tabbtn{width:100%;text-align:left;padding:10px 12px;margin:6px 0;border-radius:12px;border:1px solid var(--line);background:var(--surface);color:var(--ink);cursor:pointer}
  .tabbtn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,180,255,.15)}
  .main{padding:18px}.panel{display:none;animation:fade .2s ease}.panel.active{display:block}
  @keyframes fade{from{opacity:.2;transform:translateY(4px)}to{opacity:1;transform:none}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:0 0 14px}
  h2,h3{margin:.2rem 0 .6rem}.muted{color:var(--muted)}.small{font-size:.95rem}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
  .row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
  .btn{display:inline-block;background:var(--accent);color:#0a1020;border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
  .btn.danger{background:var(--danger)}
  .btn.success{background:var(--success)}
  input[type="number"],input[type="text"]{background:#0b1329;color:#e6eaf2;border:1px solid var(--line);border-radius:8px;padding:.35rem .45rem;width:110px}

  /* Q-cards (flip) */
  .qwrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.9rem}
  .flip{display:block;cursor:pointer;perspective:1000px}
  .flip input{display:none}.flip-inner{position:relative;transform-style:preserve-3d;transition:transform .55s}
  .flip-front,.flip-back{position:relative;min-height:120px;padding:14px;background:var(--card);border:1px solid var(--line);border-radius:14px;backface-visibility:hidden}
  .flip-back{position:absolute;inset:0;transform:rotateY(180deg)}
  .flip input:checked + .flip-inner{transform:rotateY(180deg)}
  .qtag{font-size:.7rem;background:#1b2746;border-radius:999px;padding:.08rem .45rem;margin-right:.4rem;color:#bcd0ff}

  /* MCQs */
  .mcq{counter-reset:q}
  .mcq li{list-style:none;margin:18px 0;padding:14px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#0f1730,#0e1427)}
  .mcq li::before{counter-increment:q;content:counter(q)". ";color:#c7d2fe;font-weight:700;margin-right:.35rem}
  .mcq label{display:block;margin:.35rem 0;padding:.15rem .25rem;border-radius:8px}
  .mcq input[type=radio]{accent-color:var(--accent)}
  .badge{font-size:.8rem;border-radius:8px;padding:.25rem .5rem;display:inline-block;margin:.25rem 0}
  .good{background:rgba(52,211,153,.18);color:#9cf0cf}.bad{background:rgba(248,113,113,.18);color:#fca5a5}.warn{background:rgba(167,139,250,.18);color:#ddd6fe}
  details{border:1px solid var(--line);border-radius:12px;padding:.6rem;margin:.7rem 0;background:#0f1730}
  summary{cursor:pointer;font-weight:600}

  /* GAME STYLES */
  .game-arena{text-align:center;max-width:800px;margin:0 auto}
  .game-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
  .stat-card{background:linear-gradient(145deg,#0f1830,#1a2640);border:1px solid var(--line);border-radius:12px;padding:1rem;text-align:center}
  .stat-value{font-size:2rem;font-weight:700;color:var(--accent);margin:0}
  .stat-label{font-size:.85rem;color:var(--muted);margin:.25rem 0 0}
  .question-card{background:var(--card);border:2px solid var(--line);border-radius:16px;padding:2rem;margin:1.5rem 0;min-height:200px;position:relative;overflow:hidden}
  .question-card.correct{border-color:var(--success);background:linear-gradient(145deg,#0a1a0f,var(--card))}
  .question-card.wrong{border-color:var(--danger);background:linear-gradient(145deg,#1a0a0a,var(--card))}
  .question-text{font-size:1.25rem;font-weight:600;margin-bottom:1.5rem;line-height:1.4}
  .answer-options{display:grid;gap:.75rem;max-width:500px;margin:0 auto}
  .answer-btn{background:linear-gradient(145deg,#1a2640,#0f1830);border:2px solid var(--line);color:var(--ink);padding:1rem;border-radius:12px;cursor:pointer;transition:all .2s;font-size:1rem;font-weight:500}
  .answer-btn:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(138,180,255,.3)}
  .answer-btn.correct{border-color:var(--success);background:linear-gradient(145deg,#0a1a0f,#1a4a2a)}
  .answer-btn.wrong{border-color:var(--danger);background:linear-gradient(145deg,#1a0a0a,#4a1a1a)}
  .timer-bar{height:6px;background:var(--line);border-radius:3px;overflow:hidden;margin-bottom:1rem}
  .timer-fill{height:100%;background:linear-gradient(90deg,var(--danger),#fbbf24,var(--success));transition:width .1s linear}
  .streak-indicator{position:absolute;top:1rem;right:1rem;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#0a1020;padding:.5rem 1rem;border-radius:999px;font-weight:700;font-size:.9rem}
  .game-over{text-align:center;padding:2rem}
  .final-score{font-size:3rem;font-weight:700;color:var(--accent);margin:1rem 0}
  .performance{margin:1.5rem 0}
  .perf-item{display:inline-block;margin:.5rem 1rem;font-size:1.1rem}
  .leaderboard{background:var(--card);border-radius:12px;padding:1.5rem;margin-top:1.5rem}
  .lb-entry{display:flex;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid var(--line)}
  .lb-entry:last-child{border-bottom:none}
  .difficulty-select{margin-bottom:1.5rem}
  .diff-btn{margin:0 .5rem;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;border:2px solid var(--line);background:var(--surface)}
  .diff-btn.active{border-color:var(--accent);background:linear-gradient(145deg,var(--accent-2),var(--accent));color:#0a1020}
  .footer{padding:14px 18px;border-top:1px solid var(--line);color:var(--muted);background:var(--surface)}
  ul.tight>li{margin:.25rem 0}

  /* Animations */
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
  .bounce{animation:bounce .5s ease}
  .shake{animation:shake .5s ease}
</style>
</head>
<body>
  <div class="header">
    <div class="brand"><div class="dot"></div><h1 style="font-size:1.05rem;margin:0">BUS 311 Interactive — Chapter 13</h1></div>
    <nav class="nav">
      <a href="ch9.html">Ch.9</a>
      <a href="ch11.html">Ch.11</a>
      <a href="ch12.html">Ch.12</a>
      <a class="active" href="ch13.html">Ch.13</a>
      <a href="ch15.html">Ch.15</a>
    </nav>
  </div>

  <div class="container">
    <aside class="sidebar">
      <button class="tabbtn active" data-tab="review">📘 Review</button>
      <button class="tabbtn" data-tab="qcards">🧠 Q-cards</button>
      <button class="tabbtn" data-tab="mcqs">📝 MCQs</button>
      <button class="tabbtn" data-tab="short">✍️ Short questions</button>
      <button class="tabbtn" data-tab="game">🎮 Speed Challenge</button>
    </aside>

    <main class="main">
      <!-- REVIEW -->
      <section class="panel active" id="panel-review">
        <div class="card">
          <h2>Core concepts review (≈45–55 min)</h2>
          <p class="small muted">Capital budgeting decision rules & cash-flow building. Unless stated, **ignore income taxes** (as in your problem set).</p>
          <ul class="small">
            <li><b>Relevant cash flows:</b> use **incremental** after-investment cash flows only. Include: initial outlay, installation/training, working capital changes (invest at t0, recover at end), operating cash savings/inflows, overhaul/maintenance, and salvage. **Exclude** sunk costs; **include** opportunity costs (e.g., selling old machine now).</li>
            <li><b>Replacement projects:</b> Measure differences vs. keeping old asset: (a) cash operating cost savings, (b) disposal value of old now (foregone if kept), (c) terminal salvg. of new vs old, (d) extra working capital, (e) overhaul avoided/incurred. (Depreciation affects ARR only when taxes are ignored.)</li>
            <li><b>Cash Payback Period:</b> Years needed to recover initial investment from net cash inflows. If uniform: <i>Payback = Initial / Annual cash</i>. If nonuniform: cumulate yearly until recovered. Ignores TVM & late cash flows; use only as a liquidity/rough-risk screen.</li>
            <li><b>Discounted Payback:</b> Same but with discounted cash flows; still ignores cash after payback.</li>
            <li><b>Accounting Rate of Return (ARR):</b> <i>ARR = Avg annual accounting income / Avg investment</i>.<br>
              Avg investment (straight-line) ≈ (Initial cost − Salvage at start + Salvage at end)/2. If beginning salvage=0 → (Initial + End salvage)/2. Uses accounting income (includes depreciation), not cash.</li>
            <li><b>Net Present Value (NPV):</b> Present value of inflows minus outflows at required return (<i>r</i>). Accept if **NPV&gt;0** (maximizes value).</li>
            <li><b>Internal Rate of Return (IRR):</b> Discount rate that makes NPV=0. Accept if **IRR &gt; required return**. Beware non-conventional cash flows (can give multiple IRRs) and ranking conflicts with NPV (scale/timing differences).</li>
            <li><b>Profitability Index (PI):</b> <i>PI = PV(inflows) / PV(outflows)</i>. Accept if **PI&gt;1**. Useful for **capital rationing** (bang-for-buck), but NPV is king for value.</li>
            <li><b>Decision guidance:</b>
              <ul class="tight">
                <li>Independent projects: accept all with NPV&gt;0 (or IRR&gt;hurdle) and reasonable payback.</li>
                <li>Mutually exclusive: choose highest NPV at the appropriate discount rate. Use IRR with **crossover analysis** only if consistent.</li>
                <li>Consider <b>intangible benefits/costs</b> (quality, safety, customer goodwill) as adjustments to cash flows when reasonable.</li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="grid">
          <div class="card">
            <h3>Quick formulas</h3>
            <ul class="small tight">
              <li><b>Payback (uniform)</b> = Initial / Annual net cash</li>
              <li><b>ARR</b> = Avg NI / Avg investment; Avg inv. ≈ (Initial + Salvage_end)/2 (if no beginning salvage)</li>
              <li><b>NPV</b> = Σ CF_t/(1+r)^t</li>
              <li><b>IRR</b>: r s.t. NPV=0 (use trial-and-error/interpolate)</li>
              <li><b>PI</b> = PV(inflows)/PV(outflows)</li>
            </ul>
          </div>

          <div class="card">
            <h3>Mini tool — NPV / IRR / Payback</h3>
            <p class="small muted">Enter comma-separated cash flows (t=0 first, e.g., <code>-200000,60000,70000,90000,50000</code>) and a discount rate.</p>
            <div class="row small">
              <label>Cash flows <input id="cfs" type="text" value="-200000,60000,70000,90000,50000" style="width:360px"></label>
            </div>
            <div class="row small" style="margin-top:.4rem">
              <label>r% <input id="disc" type="number" step="0.01" value="10"></label>
              <button class="btn" onclick="doNPV()">NPV</button>
              <button class="btn" onclick="doIRR()">IRR</button>
              <button class="btn ghost" onclick="doPay()">Payback</button>
            </div>
            <p id="npvout" class="muted small">Ready.</p>
          </div>
        </div>
      </section>

      <!-- Q-CARDS -->
      <section class="panel" id="panel-qcards">
        <div class="card">
          <h2>Flip Q-cards — Chapter 13</h2>
          <p class="muted small">Click to flip. Say your answer first.</p>
          <div class="qwrap">
            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front"><span class="qtag">Rules</span> Which criterion best maximizes value?</div>
              <div class="flip-back small">NPV (discount at required return; accept if NPV&gt;0).</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Payback measures…</div>
              <div class="flip-back small">Time to recover initial outlay from **cash** inflows (liquidity proxy; ignores TVM & later cash).</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">ARR uses which numerator?</div>
              <div class="flip-back small">Average **accounting income** (includes depreciation), not cash flow.</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">PI acceptance rule</div>
              <div class="flip-back small">Accept if PI&gt;1 (PV inflows &gt; PV outflows).</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Multiple IRRs happen when…</div>
              <div class="flip-back small">Cash flows change sign more than once (non-conventional).</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Mutually exclusive projects: which rule?</div>
              <div class="flip-back small">Choose **highest NPV** at the hurdle rate; IRR ranking can mislead (scale/timing).</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Working capital in NPV</div>
              <div class="flip-back small">Cash outflow at start; recovered at project end.</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Replacement: include sale of old asset now?</div>
              <div class="flip-back small">Yes — it's an **opportunity cost** (cash you give up if you keep the old asset).</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Discounted payback vs payback</div>
              <div class="flip-back small">Discounted uses PVs (respects TVM) but still ignores cash after cutoff.</div>
            </div></label>

            <label class="flip"><input type="checkbox"><div class="flip-inner">
              <div class="flip-front">Intangible benefits?</div>
              <div class="flip-back small">Quality, safety, goodwill, training. If measurable, add as cash flows; otherwise discuss qualitatively.</div>
            </div></label>
          </div>
        </div>
      </section>

      <!-- MCQs -->
      <section class="panel" id="panel-mcqs">
        <div class="card">
          <h2>MCQ drill (auto-graded)</h2>
          <p class="muted small">Pick answers, then press <b>Grade</b>. Explanations appear for misses.</p>
          <ol class="mcq small" id="mcq13">
            <li>The decision rule that most directly maximizes shareholder value is:
              <label><input type="radio" name="q1" value="a" data-ok>NPV</label>
              <label><input type="radio" name="q1" value="b">IRR</label>
              <label><input type="radio" name="q1" value="c">Payback</label>
            </li>
            <li>NPV generally ______ when the discount rate increases.
              <label><input type="radio" name="q2" value="a" data-ok>decreases</label>
              <label><input type="radio" name="q2" value="b">increases</label>
              <label><input type="radio" name="q2" value="c">is unchanged</label>
            </li>
            <li>Uniform cash inflow $40,000/yr, initial $160,000. Payback =
              <label><input type="radio" name="q3" value="a">3.0 years</label>
              <label><input type="radio" name="q3" value="b" data-ok>4.0 years</label>
              <label><input type="radio" name="q3" value="c">5.0 years</label>
            </li>
            <li>ARR uses which denominator for straight-line with zero begin salvage?
              <label><input type="radio" name="q4" value="a">Initial cost</label>
              <label><input type="radio" name="q4" value="b" data-ok>Average investment ≈ (Initial + End salvage)/2</label>
              <label><input type="radio" name="q4" value="c">PV of cash flows</label>
            </li>
            <li>PV(inflows)=$520k; PV(outflows)=$500k. PI and decision?
              <label><input type="radio" name="q5" value="a" data-ok>PI=1.04; Accept</label>
              <label><input type="radio" name="q5" value="b">PI=0.96; Reject</label>
              <label><input type="radio" name="q5" value="c">PI=1.04; Reject</label>
            </li>

            <li>Which cash item is **not** incremental for a replacement project?
              <label><input type="radio" name="q6" value="a">Avoided maintenance on the old machine</label>
              <label><input type="radio" name="q6" value="b" data-ok>Sunk R&D spent last year</label>
              <label><input type="radio" name="q6" value="c">Sale proceeds of the old machine now</label>
            </li>
            <li>If cash flows change sign more than once, IRR may:
              <label><input type="radio" name="q7" value="a" data-ok>Have multiple values or be unreliable</label>
              <label><input type="radio" name="q7" value="b">Equal WACC</label>
              <label><input type="radio" name="q7" value="c">Always exceed NPV</label>
            </li>
            <li>Two mutually exclusive projects: A has higher IRR; B has higher NPV at 10%. Choose:
              <label><input type="radio" name="q8" value="a">A</label>
              <label><input type="radio" name="q8" value="b" data-ok>B (higher NPV at the hurdle)</label>
              <label><input type="radio" name="q8" value="c">Either</label>
            </li>
            <li>Working capital of $25k is required at t=0 and fully recovered at end. In NPV we:
              <label><input type="radio" name="q9" value="a" data-ok>Subtract $25k at t=0; add $25k at terminal year</label>
              <label><input type="radio" name="q9" value="b">Ignore it</label>
              <label><input type="radio" name="q9" value="c">Include only at t=0</label>
            </li>
            <li>Discounted payback will always be:
              <label><input type="radio" name="q10" value="a">Shorter than simple payback</label>
              <label><input type="radio" name="q10" value="b" data-ok>Longer than (or equal to) simple payback</label>
              <label><input type="radio" name="q10" value="c">Equal to IRR</label>
            </li>

            <li>Initial $300k; cash inflows 100k, 120k, 140k at years 1–3; r=10%. NPV is closest to:
              <label><input type="radio" name="q11" value="a" data-ok>$15k</label>
              <label><input type="radio" name="q11" value="b">$−5k</label>
              <label><input type="radio" name="q11" value="c">$30k</label>
            </li>
            <li>A project with PI=0.9 and positive payback should be:
              <label><input type="radio" name="q12" value="a">Accepted</label>
              <label><input type="radio" name="q12" value="b" data-ok>Rejected (PI&lt;1 ⇒ negative NPV)</label>
              <label><input type="radio" name="q12" value="c">Deferred</label>
            </li>
            <li>For capital rationing under a single-period budget, a useful ranking metric is:
              <label><input type="radio" name="q13" value="a" data-ok>Profitability Index</label>
              <label><input type="radio" name="q13" value="b">Payback</label>
              <label><input type="radio" name="q13" value="c">ARR</label>
            </li>
            <li>Including intangible benefits in the analysis will typically:
              <label><input type="radio" name="q14" value="a">Lower NPV</label>
              <label><input type="radio" name="q14" value="b" data-ok>Raise NPV if they are additional cash inflows/savings</label>
              <label><input type="radio" name="q14" value="c">Have no effect</label>
            </li>
            <li>Which statement is **true**?
              <label><input type="radio" name="q15" value="a">ARR and NPV always agree</label>
              <label><input type="radio" name="q15" value="b" data-ok>NPV accounts for timing and required return; ARR does not</label>
              <label><input type="radio" name="q15" value="c">IRR never conflicts with NPV</label>
            </li>
          </ol>
          <button class="btn" onclick="gradeMCQ('mcq13','mcq13res')">Grade</button>
          <button class="btn ghost" onclick="resetMCQ('mcq13','mcq13res')">Reset</button>
          <p id="mcq13res" class="small muted"></p>
        </div>
      </section>

      <!-- SHORT NUMERICALS -->
      <section class="panel" id="panel-short">
        <div class="card">
          <h2>Practice Set B — Short numericals (fully worked)</h2>
          <p class="muted small">These mirror your textbook problems (no income taxes unless noted). Expand to see steps.</p>

          <details class="small"><summary><b>B1) Payback (nonuniform)</b> — Initial $150,000; cash inflows by year: 40k, 55k, 35k, 30k, 25k. Payback?</summary>
            <p>Cumulatives: Y1=40; Y2=95; Y3=130; Y4=160 ⇒ recover at year 4. Fraction in year 4: (150−130)/30 = 0.667. Payback ≈ <b>3.67 years</b>.</p>
          </details>

          <details class="small"><summary><b>B2) ARR</b> — Machine costs $100,000, life 5 yrs, salvage $10,000 (straight-line). Annual net cash inflow $28,000. Compute ARR.</summary>
            <p>Depreciation = (100,000−10,000)/5 = 18,000. Accounting income = 28,000−18,000 = 10,000. Avg investment ≈ (100,000+10,000)/2 = 55,000. ARR = 10,000/55,000 = <b>18.18%</b>.</p>
          </details>

          <details class="small"><summary><b>B3) NPV</b> — Initial outlay $200,000; cash inflows 60k, 70k, 80k, 90k over 4 years; r=10%.</summary>
            <p>PV=60/1.1 + 70/1.1² + 80/1.1³ + 90/1.1⁴ = 54.55 + 57.85 + 60.05 + 61.46 = 233.91k. NPV=233.91−200 = <b>$33.91k</b>.</p>
          </details>

          <details class="small"><summary><b>B4) IRR (interpolate)</b> — Use B3 cash flows. At 10% NPV=+33.91k. At 18% PV = 50.85+50.30+48.24+45.46=194.85 → NPV=−5.15k. IRR ≈ ?</summary>
            <p>IRR ≈ 10% + (33.91/(33.91+5.15))·(18%−10%) = 10% + (33.91/39.06)·8% ≈ 10% + 6.94% = <b>16.94%</b>.</p>
          </details>

          <details class="small"><summary><b>B5) PI</b> — Using B3 at r=10%.</summary>
            <p>PV(inflows)=233.91; PV(outflows)=200 ⇒ PI = 233.91/200 = <b>1.1695</b>.</p>
          </details>

          <details class="small"><summary><b>B6) Replacement (incremental, no taxes)</b> — Old machine can be sold now for $20,000 or kept 4 more years with annual operating cost $50,000 and zero salvage. New machine costs $120,000 now, reduces annual operating cost to $20,000, life 4 years, salvage $10,000. r=12%. Should we replace?</summary>
            <p>Initial differential outflow at t0 = Cost_new − sale_old_now = 120 − 20 = <b>$100k</b> (since selling old is an inflow avoided if keep). Annual cash savings = 50−20 = 30k for 4 years. Terminal differential = +10k salvage (new) − 0 (old) = +10k.</p>
            <p>PV of savings = 30k × annuity(12%,4)=30×3.0373=91.12k. PV terminal = 10/1.12⁴=6.35k. NPV = 91.12 + 6.35 − 100 = <b>−$2.53k</b> ⇒ <b>Keep old</b> (borderline; intangible advantages might tip decision).</p>
          </details>

          <details class="small"><summary><b>B7) Working capital</b> — Project requires $15k inventory at t0, recovered at year 5. Annual cash inflow 7k for 5 years; initial equipment 20k; r=10%. NPV?</summary>
            <p>Outflows at t0: 20 + 15 = 35k. PV inflows of 7k for 5y @10% = 7×3.7908 = 26.54k. PV of WC recovery = 15/1.1⁵ = 9.31k. NPV = 26.54 + 9.31 − 35 = <b>$0.85k</b> ⇒ Slightly acceptable.</p>
          </details>

          <details class="small"><summary><b>B8) Mutually exclusive choice</b> — A: NPV=$60k, initial $200k. B: NPV=$70k, initial $350k. Rationing budget $350k. Which set maximizes value?</summary>
            <p>Feasible combos: {A} uses 200 (NPV 60), {B} uses 350 (NPV 70), {A+A} not allowed (only one each), {A + something else} none. Choose <b>B</b> (NPV 70 & fits budget), even though PI(A)=1.30 &gt; PI(B)=1.20.</p>
          </details>
        </div>
      </section>

      <!-- SPEED CHALLENGE GAME -->
      <section class="panel" id="panel-game">
        <div class="card">
          <h2>🎮 Capital Budgeting Speed Challenge</h2>
          <p class="muted small">Test your knowledge in this fast-paced game! Answer quickly to build streaks and earn bonus points.</p>
          
          <div class="game-arena">
            <!-- Game Start Screen -->
            <div id="game-start" class="game-over">
              <h3>Ready to test your Capital Budgeting mastery?</h3>
              <div class="difficulty-select">
                <h4>Choose Difficulty:</h4>
                <button class="diff-btn active" data-diff="easy">Easy<br><small>15s per question</small></button>
                <button class="diff-btn" data-diff="medium">Medium<br><small>10s per question</small></button>
                <button class="diff-btn" data-diff="hard">Hard<br><small>7s per question</small></button>
              </div>
              <button class="btn" onclick="startGame()">Start Challenge</button>
              
              <!-- Leaderboard -->
              <div class="leaderboard">
                <h4>🏆 High Scores</h4>
                <div id="leaderboard-list">
                  <div class="lb-entry"><span>No scores yet!</span><span>Play to set records</span></div>
                </div>
              </div>
            </div>

            <!-- Game Stats -->
            <div id="game-stats" class="game-stats" style="display:none">
              <div class="stat-card">
                <div class="stat-value" id="score">0</div>
                <div class="stat-label">Score</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Streak</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="correct">0</div>
                <div class="stat-label">Correct</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="remaining">10</div>
                <div class="stat-label">Remaining</div>
              </div>
            </div>

            <!-- Question Card -->
            <div id="question-container" style="display:none">
              <div class="timer-bar">
                <div class="timer-fill" id="timer-fill"></div>
              </div>
              
              <div class="question-card" id="question-card">
                <div class="streak-indicator" id="streak-display" style="display:none">🔥 Streak: <span id="streak-num">0</span></div>
                <div class="question-text" id="question-text"></div>
                <div class="answer-options" id="answer-options"></div>
              </div>
              
              <button class="btn ghost" onclick="skipQuestion()">Skip Question</button>
            </div>

            <!-- Game Over Screen -->
            <div id="game-over" class="game-over" style="display:none">
              <h3>🎉 Challenge Complete!</h3>
              <div class="final-score" id="final-score">0</div>
              <div class="performance">
                <div class="perf-item">✅ Correct: <strong id="final-correct">0</strong></div>
                <div class="perf-item">❌ Wrong: <strong id="final-wrong">0</strong></div>
                <div class="perf-item">🔥 Best Streak: <strong id="final-streak">0</strong></div>
                <div class="perf-item">⚡ Avg Time: <strong id="avg-time">0s</strong></div>
              </div>
              <div class="performance-message" id="performance-msg"></div>
              <button class="btn" onclick="resetGame()">Play Again</button>
              <button class="btn ghost" onclick="showLeaderboard()">View Leaderboard</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="footer">© BUS 311 Interactive • Chapter 13</div>

<script>
  // Tabs
  const btns=[...document.querySelectorAll('.tabbtn')];
  const panels={
    review:document.getElementById('panel-review'),
    qcards:document.getElementById('panel-qcards'),
    mcqs:document.getElementById('panel-mcqs'),
    short:document.getElementById('panel-short'),
    game:document.getElementById('panel-game')
  };
  btns.forEach(b=>{
    b.addEventListener('click',()=>{
      btns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      Object.values(panels).forEach(p=>p.classList.remove('active'));
      panels[b.dataset.tab].classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  // Difficulty buttons
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // Speed Challenge Game
  let gameState = {
    score: 0,
    streak: 0,
    bestStreak: 0,
    correct: 0,
    wrong: 0,
    currentQuestion: 0,
    totalQuestions: 10,
    difficulty: 'easy',
    timer: null,
    timeLeft: 15,
    questionStartTime: 0,
    responseTimes: []
  };

  const difficulties = {
    easy: { time: 15, scoreMultiplier: 1, streakBonus: 10 },
    medium: { time: 10, scoreMultiplier: 1.5, streakBonus: 15 },
    hard: { time: 7, scoreMultiplier: 2, streakBonus: 25 }
  };

  // Question bank for Chapter 13 Capital Budgeting
  const questions = [
    {
      text: "Which decision rule directly maximizes shareholder value?",
      answers: ["NPV", "IRR", "Payback", "ARR"],
      correct: 0,
      explanation: "NPV measures the dollar value added to the firm"
    },
    {
      text: "Initial investment $200k, annual cash flow $50k. Simple payback period?",
      answers: ["3 years", "4 years", "5 years", "6 years"],
      correct: 1,
      explanation: "Payback = $200k ÷ $50k = 4 years"
    },
    {
      text: "If NPV = +$10,000 at 10% discount rate, what happens to NPV if rate increases to 12%?",
      answers: ["NPV increases", "NPV decreases", "NPV stays same", "Cannot determine"],
      correct: 1,
      explanation: "Higher discount rates reduce present values, lowering NPV"
    },
    {
      text: "Project A: NPV $30k, Investment $100k. Project B: NPV $40k, Investment $200k. Under capital rationing ($200k budget), choose:",
      answers: ["Project A only", "Project B only", "Both projects", "Neither project"],
      correct: 1,
      explanation: "Project B has higher absolute NPV and fits within budget constraint"
    },
    {
      text: "ARR calculation uses which type of income?",
      answers: ["Cash flow", "Accounting income", "Operating income", "EBITDA"],
      correct: 1,
      explanation: "ARR uses accounting income (includes depreciation), not cash flow"
    },
    {
      text: "PV of inflows = $520k, PV of outflows = $500k. Profitability Index?",
      answers: ["0.96", "1.04", "1.20", "1.40"],
      correct: 1,
      explanation: "PI = PV(inflows) ÷ PV(outflows) = $520k ÷ $500k = 1.04"
    },
    {
      text: "Which is NOT relevant for replacement project analysis?",
      answers: ["Sunk R&D costs", "Sale value of old asset", "Operating cost savings", "Incremental depreciation"],
      correct: 0,
      explanation: "Sunk costs are irrelevant - they're already spent regardless of decision"
    },
    {
      text: "Working capital investment of $25k at project start, recovered at end. How treat in NPV?",
      answers: ["Ignore completely", "Only subtract at start", "Subtract at start, add at end", "Only add at end"],
      correct: 2,
      explanation: "Working capital is a cash outflow initially, then recovered (inflow) at project end"
    },
    {
      text: "For mutually exclusive projects with conflicting NPV vs IRR rankings, choose based on:",
      answers: ["Higher IRR", "Higher NPV", "Lower payback", "Higher PI"],
      correct: 1,
      explanation: "NPV measures absolute value creation; IRR can mislead due to scale/timing differences"
    },
    {
      text: "Non-conventional cash flows (multiple sign changes) can cause:",
      answers: ["No IRR solution", "Multiple IRR solutions", "Negative NPV always", "Infinite payback"],
      correct: 1,
      explanation: "Sign changes can create multiple IRR solutions, making IRR unreliable"
    },
    {
      text: "Machine cost $100k, 5-year life, $10k salvage, $28k annual cash flow. Average investment for ARR?",
      answers: ["$50k", "$55k", "$90k", "$100k"],
      correct: 1,
      explanation: "Average investment = (Initial cost + Salvage value) ÷ 2 = ($100k + $10k) ÷ 2 = $55k"
    },
    {
      text: "Discounted payback vs simple payback:",
      answers: ["Discounted is shorter", "Discounted is longer", "Both are equal", "Depends on discount rate"],
      correct: 1,
      explanation: "Discounting reduces cash flow values, so takes longer to recover initial investment"
    },
    {
      text: "Which factor would INCREASE a project's NPV?",
      answers: ["Higher discount rate", "Lower cash flows", "Higher working capital needs", "Lower discount rate"],
      correct: 3,
      explanation: "Lower discount rate increases present value of future cash flows"
    },
    {
      text: "A project with PI = 0.9 should be:",
      answers: ["Accepted", "Rejected", "Further analyzed", "Implemented immediately"],
      correct: 1,
      explanation: "PI < 1 implies negative NPV, so project destroys value"
    },
    {
      text: "Best metric for capital rationing decisions:",
      answers: ["NPV", "IRR", "Profitability Index", "Payback"],
      correct: 2,
      explanation: "PI shows value created per dollar invested - best for limited capital allocation"
    }
  ];

  function startGame() {
    const selectedDiff = document.querySelector('.diff-btn.active').dataset.diff;
    gameState.difficulty = selectedDiff;
    gameState.timeLeft = difficulties[selectedDiff].time;
    
    // Reset game state
    gameState.score = 0;
    gameState.streak = 0;
    gameState.bestStreak = 0;
    gameState.correct = 0;
    gameState.wrong = 0;
    gameState.currentQuestion = 0;
    gameState.responseTimes = [];
    
    // Shuffle questions
    gameState.questions = [...questions].sort(() => Math.random() - 0.5).slice(0, gameState.totalQuestions);
    
    // Show game UI
    document.getElementById('game-start').style.display = 'none';
    document.getElementById('game-stats').style.display = 'grid';
    document.getElementById('question-container').style.display = 'block';
    
    updateStats();
    showNextQuestion();
  }

  function updateStats() {
    document.getElementById('score').textContent = gameState.score;
    document.getElementById('streak').textContent = gameState.streak;
    document.getElementById('correct').textContent = gameState.correct;
    document.getElementById('remaining').textContent = gameState.totalQuestions - gameState.currentQuestion;
  }

  function showNextQuestion() {
    if (gameState.currentQuestion >= gameState.totalQuestions) {
      endGame();
      return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    const questionCard = document.getElementById('question-card');
    
    // Reset card styling
    questionCard.className = 'question-card';
    
    // Set question text
    document.getElementById('question-text').textContent = question.text;
    
    // Create answer options
    const optionsContainer = document.getElementById('answer-options');
    optionsContainer.innerHTML = '';
    
    question.answers.forEach((answer, index) => {
      const button = document.createElement('button');
      button.className = 'answer-btn';
      button.textContent = answer;
      button.onclick = () => selectAnswer(index);
      optionsContainer.appendChild(button);
    });
    
    // Update streak display
    const streakDisplay = document.getElementById('streak-display');
    if (gameState.streak > 0) {
      streakDisplay.style.display = 'block';
      document.getElementById('streak-num').textContent = gameState.streak;
    } else {
      streakDisplay.style.display = 'none';
    }
    
    // Start timer
    startTimer();
    gameState.questionStartTime = Date.now();
  }

  function startTimer() {
    gameState.timeLeft = difficulties[gameState.difficulty].time;
    updateTimerBar();
    
    gameState.timer = setInterval(() => {
      gameState.timeLeft--;
      updateTimerBar();
      
      if (gameState.timeLeft <= 0) {
        clearInterval(gameState.timer);
        selectAnswer(-1); // Time up = wrong answer
      }
    }, 1000);
  }

  function updateTimerBar() {
    const maxTime = difficulties[gameState.difficulty].time;
    const percentage = (gameState.timeLeft / maxTime) * 100;
    document.getElementById('timer-fill').style.width = percentage + '%';
  }

  function selectAnswer(selectedIndex) {
    clearInterval(gameState.timer);
    
    const responseTime = (Date.now() - gameState.questionStartTime) / 1000;
    gameState.responseTimes.push(responseTime);
    
    const question = gameState.questions[gameState.currentQuestion];
    const isCorrect = selectedIndex === question.correct;
    const questionCard = document.getElementById('question-card');
    const answerButtons = document.querySelectorAll('.answer-btn');
    
    // Disable all buttons
    answerButtons.forEach(btn => btn.onclick = null);
    
    // Show correct answer
    answerButtons.forEach((btn, index) => {
      if (index === question.correct) {
        btn.classList.add('correct');
      } else if (index === selectedIndex && !isCorrect) {
        btn.classList.add('wrong');
      }
    });
    
    if (isCorrect) {
      gameState.correct++;
      gameState.streak++;
      gameState.bestStreak = Math.max(gameState.bestStreak, gameState.streak);
      
      // Calculate score
      const basePoints = 100;
      const timeBonus = Math.floor(gameState.timeLeft * 5);
      const streakBonus = gameState.streak * difficulties[gameState.difficulty].streakBonus;
      const difficultyMultiplier = difficulties[gameState.difficulty].scoreMultiplier;
      
      const points = Math.floor((basePoints + timeBonus + streakBonus) * difficultyMultiplier);
      gameState.score += points;
      
      questionCard.classList.add('correct');
      questionCard.classList.add('bounce');
      
    } else {
      gameState.wrong++;
      gameState.streak = 0;
      questionCard.classList.add('wrong');
      questionCard.classList.add('shake');
    }
    
    gameState.currentQuestion++;
    updateStats();
    
    // Show next question after delay
    setTimeout(() => {
      questionCard.classList.remove('bounce', 'shake');
      showNextQuestion();
    }, 2000);
  }

  function skipQuestion() {
    selectAnswer(-1); // Treat skip as wrong answer
  }

  function endGame() {
    // Hide game UI
    document.getElementById('game-stats').style.display = 'none';
    document.getElementById('question-container').style.display = 'none';
    
    // Show results
    const gameOver = document.getElementById('game-over');
    gameOver.style.display = 'block';
    
    document.getElementById('final-score').textContent = gameState.score;
    document.getElementById('final-correct').textContent = gameState.correct;
    document.getElementById('final-wrong').textContent = gameState.wrong;
    document.getElementById('final-streak').textContent = gameState.bestStreak;
    
    const avgTime = gameState.responseTimes.length > 0 
      ? (gameState.responseTimes.reduce((a, b) => a + b, 0) / gameState.responseTimes.length).toFixed(1)
      : '0';
    document.getElementById('avg-time').textContent = avgTime + 's';
    
    // Performance message
    const accuracy = (gameState.correct / gameState.totalQuestions) * 100;
    let message = '';
    if (accuracy >= 90) message = '🌟 Outstanding! You\'re a Capital Budgeting expert!';
    else if (accuracy >= 80) message = '🎯 Excellent work! You\'ve mastered the key concepts!';
    else if (accuracy >= 70) message = '👍 Good job! Review the concepts you missed.';
    else if (accuracy >= 60) message = '📚 Keep studying! You\'re getting there.';
    else message = '💪 Don\'t give up! Review the chapter and try again.';
    
    document.getElementById('performance-msg').innerHTML = message;
    
    // Save to leaderboard
    saveScore();
  }

  function resetGame() {
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('game-start').style.display = 'block';
    loadLeaderboard();
  }

  function saveScore() {
    const scores = JSON.parse(localStorage.getItem('ch13_scores') || '[]');
    const newScore = {
      score: gameState.score,
      difficulty: gameState.difficulty,
      accuracy: Math.round((gameState.correct / gameState.totalQuestions) * 100),
      date: new Date().toLocaleDateString()
    };
    
    scores.push(newScore);
    scores.sort((a, b) => b.score - a.score);
    scores.splice(5); // Keep top 5
    
    localStorage.setItem('ch13_scores', JSON.stringify(scores));
    loadLeaderboard();
  }

  function loadLeaderboard() {
    const scores = JSON.parse(localStorage.getItem('ch13_scores') || '[]');
    const leaderboard = document.getElementById('leaderboard-list');
    
    if (scores.length === 0) {
      leaderboard.innerHTML = '<div class="lb-entry"><span>No scores yet!</span><span>Play to set records</span></div>';
      return;
    }
    
    leaderboard.innerHTML = scores.map((score, index) => `
      <div class="lb-entry">
        <span>#${index + 1} • ${score.score} pts (${score.accuracy}%)</span>
        <span>${score.difficulty.toUpperCase()} • ${score.date}</span>
      </div>
    `).join('');
  }

  function showLeaderboard() {
    resetGame();
  }

  // Initialize leaderboard on page load
  loadLeaderboard();

  // Mini NPV/IRR/Payback
  function parseCF(){return document.getElementById('cfs').value.split(',').map(x=>parseFloat(x.trim())).filter(x=>!isNaN(x));}
  function doNPV(){
    const r=parseFloat(document.getElementById('disc').value||0)/100;
    const cfs=parseCF(); let npv=0;
    cfs.forEach((cf,t)=>{npv+=cf/Math.pow(1+r,t);});
    document.getElementById('npvout').innerHTML=`NPV @ ${ (100*r).toFixed(2)}% = <b>$${npv.toFixed(2)}</b>`;
  }
  function doIRR(){
    const cfs=parseCF();
    let lo=-0.99, hi=10, mid, f;
    const npv=(rate)=>cfs.reduce((acc,cf,t)=>acc+cf/Math.pow(1+rate,t),0);
    while(npv(hi)>0 && hi<50) hi*=1.5;
    if(npv(lo)*npv(hi)>0){document.getElementById('npvout').innerHTML='IRR not found (non-conventional CF or no sign change).';return;}
    for(let i=0;i<80;i++){mid=(lo+hi)/2; f=npv(mid); if(Math.abs(f)<1e-7) break; (f>0? lo:hi)=mid;}
    document.getElementById('npvout').innerHTML=`IRR ≈ <b>${(100*mid).toFixed(3)}%</b>`;
  }
  function doPay(){
    const cfs=parseCF(); if(cfs.length<2){document.getElementById('npvout').textContent='Enter CFs.';return;}
    let need=-cfs[0], year=0;
    for(let t=1;t<cfs.length;t++){
      if(need<=0) break;
      if(cfs[t]>=need){const frac=need/cfs[t]; document.getElementById('npvout').innerHTML=`Payback ≈ <b>${(t-1+frac).toFixed(2)} years</b>`;return;}
      need-=cfs[t]; year=t;
    }
    document.getElementById('npvout').innerHTML='Not recovered within horizon.';
  }

  // MCQ grading
  function gradeMCQ(listId,resId){
    const list=document.querySelectorAll(`#${listId} li`);
    let right=0,total=list.length,explain=[];
    list.forEach((li,idx)=>{
      const sel=li.querySelector('input[type=radio]:checked');
      const ok=li.querySelector('input[data-ok]');
      const good=sel && sel.value===ok.value;
      if(good){right++; li.style.borderColor='rgba(52,211,153,.45)';}
      else{
        li.style.borderColor='rgba(248,113,113,.45)';
        const q=idx+1;
        let why='';
        switch(q){
          case 1: why='NPV directly measures value added at the hurdle rate.';break;
          case 2: why='Higher r ⇒ lower PVs ⇒ lower NPV.';break;
          case 4: why='ARR denominator is average investment under SL depreciation.';break;
          case 6: why='Sunk costs are excluded—only incremental cash matters.';break;
          case 7: why='Non-conventional CFs can produce multiple IRRs.';break;
          case 8: why='For ME projects, pick the one with higher NPV at the hurdle rate.';break;
          case 9: why='WC is an outflow now and an inflow when recovered.';break;
          case 10: why='Discounted payback uses PVs → slower recovery.';break;
          case 11: why='Compute PVs at 10% and subtract 300k (≈$15k).';break;
          case 12: why='PI<1 ⇔ NPV<0 even if payback looks okay.';break;
          case 13: why='PI ranks by NPV per dollar under a budget.';break;
          case 15: why='ARR ignores timing/required return; NPV includes both.';break;
        }
        explain.push(`${q}) Correct: <b>${ok.value.toUpperCase()}</b>${why?' — '+why:''}`);
      }
    });
    const res=document.getElementById(resId);
    res.innerHTML = `<span class="badge ${right===total?'good':right/total>.6?'warn':'bad'}">Score: ${right}/${total}</span>`+
      (explain.length?`<br><span class="muted small">${explain.join(' • ')}</span>`:'');
  }
  function resetMCQ(listId,resId){
    document.querySelectorAll(`#${listId} input[type=radio]`).forEach(r=>r.checked=false);
    document.getElementById(resId).textContent='';
    document.querySelectorAll(`#${listId} li`).forEach(li=>li.style.borderColor='var(--line)');
  }
</script>
<script src="../assets/app.js"></script>
</body>
</html>
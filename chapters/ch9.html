<!-- FILE: chapters/ch9.html (Updated to match Chapter 12 styling with white font) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chapter 9 · Financial Manager & Markets</title>
<style>
  :root{
    --bg:#0f1116; --panel:#141821; --sunken:#0b0e14;
    --text:#ffffff; --muted:#a5b3d9; --accent:#7aa2f7; --good:#4ade80; --bad:#f87171; --warn:#facc15;
    --card:#0f1522; --cardEdge:#1b2233; --chip:#192033;
    --success:#34d399; --danger:#f87171;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0c0f15 50%, var(--bg));
    color:var(--text); font:15px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    display:flex; gap:0;
  }
  /* Sidebar */
  .sidebar{
    width:280px; background:var(--panel); border-right:1px solid #1d2332; padding:18px 12px; position:sticky; top:0; height:100vh; overflow:auto;
  }
  .brand{display:flex; align-items:center; gap:10px; padding:6px 10px 14px; border-bottom:1px solid #1c2230; margin-bottom:14px}
  .brand .dot{width:10px; height:10px; border-radius:50%; background:conic-gradient(var(--accent), #8bd5ff)}
  .brand h1{font-size:16px; margin:0; letter-spacing:.3px; color:#ffffff}
  .tablist{display:flex; flex-direction:column; gap:8px; margin-top:10px}
  .tabbtn{
    text-align:left; width:100%; border:1px solid #20283a; background:var(--sunken);
    color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; transition:.15s ease;
  }
  .tabbtn:hover{border-color:#2a3550; transform:translateY(-1px)}
  .tabbtn.active{background:#122038; border-color:#2b3f6b; box-shadow:0 0 0 2px #1f2a44 inset}
  .small{color:var(--muted); font-size:12px}

  /* Main */
  .main{flex:1; min-width:0; padding:24px; overflow:auto}
  .hero{
    background:radial-gradient(1200px 400px at 20% -20%, #203255 0%, transparent 60%),
               radial-gradient(800px 300px at 110% -30%, #1a263f 0%, transparent 70%);
    border:1px solid #1c2436; border-radius:14px; padding:20px; margin-bottom:18px;
  }
  h2{margin:0 0 10px 0; font-size:22px; color:#ffffff}
  h3{margin:22px 0 8px; font-size:18px; color:#ffffff}
  p{margin:8px 0; color:#ffffff}
  .chip{display:inline-block; background:var(--chip); border:1px solid #24304a; color:#ffffff; padding:4px 8px; border-radius:999px; font-size:12px; margin:2px 4px 2px 0}
  .grid{display:grid; gap:14px}
  .grid.cols-2{grid-template-columns:repeat(auto-fit, minmax(280px,1fr))}
  .panel{background:var(--panel); border:1px solid #1c2436; border-radius:14px; padding:16px}
  .callout{border-left:3px solid var(--accent); background:#0f1728; padding:10px 12px; border-radius:8px; color:#ffffff}
  .katex{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  code, .monospace{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:13px; color:#ffffff}
  .muted{color:var(--muted)}

  /* Cards */
  .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .qcard{
    perspective:1000px; height:150px;
  }
  .q-inner{position:relative; height:100%; transform-style:preserve-3d; transition:transform .55s cubic-bezier(.2,.7,.2,1)}
  .qcard:hover .q-inner{transform:rotateY(180deg)}
  .face{
    position:absolute; inset:0; backface-visibility:hidden; background:var(--card); border:1px solid var(--cardEdge);
    border-radius:14px; padding:14px; display:flex; align-items:center; justify-content:center; text-align:center; color:#ffffff
  }
  .face.back{transform:rotateY(180deg); background:#0f1626}
  .face strong{color:#ffffff}

  /* MCQs */
  .mcq{background:var(--panel); border:1px solid #1c2436; border-radius:14px; padding:16px; margin:10px 0}
  .mcq h4{margin:0 0 10px 0; color:#ffffff}
  .opt{display:block; padding:8px 10px; margin:6px 0; border:1px solid #20283a; border-radius:10px; cursor:pointer; color:#ffffff}
  .opt:hover{background:#101728}
  .correct{border-color:#275b3c; background:#0f1b17}
  .wrong{border-color:#5b2727; background:#1b0f10}
  .explain{display:none; margin-top:8px; color:#ffffff}
  .spacer{height:8px}
  .solutions-block{display:none; padding:10px; border-top:1px dashed #2b3752; margin-top:8px; color:#ffffff}
  .btn{background:#13213a; border:1px solid #273758; color:#ffffff; padding:8px 10px; border-radius:10px; cursor:pointer}
  .btn:hover{background:#152747}

  /* Short Qs & Practice */
  details{background:var(--sunken); border:1px solid #23304a; border-radius:12px; padding:10px 12px; margin:10px 0}
  summary{cursor:pointer; font-weight:600; color:#ffffff}
  .solve{margin-top:8px; color:#ffffff}
  .tag{font-size:11px; padding:2px 6px; border:1px solid #2a3552; background:#101727; border-radius:999px; color:#ffffff; margin-left:6px}

  /* Tabs */
  .tabcontent{display:none}
  .tabcontent.active{display:block; animation:fade .25s ease}
  @keyframes fade{from{opacity:.5; transform:translateY(2px)} to{opacity:1; transform:none}}

  /* Input styling */
  input[type="number"], input[type="text"]{
    background:#0b1329; color:#ffffff; border:1px solid #24305e; padding:.25rem; border-radius:8px; width:90px;
  }

  /* GAME STYLES */
  .game-arena{text-align:center;max-width:800px;margin:0 auto}
  .game-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
  .stat-card{background:linear-gradient(145deg,#0f1830,#1a2640);border:1px solid #1c2436;border-radius:12px;padding:1rem;text-align:center}
  .stat-value{font-size:2rem;font-weight:700;color:var(--accent);margin:0}
  .stat-label{font-size:.85rem;color:var(--muted);margin:.25rem 0 0}
  .question-card{background:var(--card);border:2px solid #1c2436;border-radius:16px;padding:2rem;margin:1.5rem 0;min-height:200px;position:relative;overflow:hidden}
  .question-card.correct{border-color:var(--success);background:linear-gradient(145deg,#0a1a0f,var(--card))}
  .question-card.wrong{border-color:var(--danger);background:linear-gradient(145deg,#1a0a0a,var(--card))}
  .question-text{font-size:1.25rem;font-weight:600;margin-bottom:1.5rem;line-height:1.4;color:#ffffff}
  .answer-options{display:grid;gap:.75rem;max-width:500px;margin:0 auto}
  .answer-btn{background:linear-gradient(145deg,#1a2640,#0f1830);border:2px solid #1c2436;color:#ffffff;padding:1rem;border-radius:12px;cursor:pointer;transition:all .2s;font-size:1rem;font-weight:500}
  .answer-btn:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(122,162,247,.3)}
  .answer-btn.correct{border-color:var(--success);background:linear-gradient(145deg,#0a1a0f,#1a4a2a)}
  .answer-btn.wrong{border-color:var(--danger);background:linear-gradient(145deg,#1a0a0a,#4a1a1a)}
  .timer-bar{height:6px;background:#1c2436;border-radius:3px;overflow:hidden;margin-bottom:1rem}
  .timer-fill{height:100%;background:linear-gradient(90deg,var(--danger),#fbbf24,var(--success));transition:width .1s linear}
  .streak-indicator{position:absolute;top:1rem;right:1rem;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#0a1020;padding:.5rem 1rem;border-radius:999px;font-weight:700;font-size:.9rem}
  .game-over{text-align:center;padding:2rem}
  .final-score{font-size:3rem;font-weight:700;color:var(--accent);margin:1rem 0}
  .performance{margin:1.5rem 0}
  .perf-item{display:inline-block;margin:.5rem 1rem;font-size:1.1rem;color:#ffffff}
  .leaderboard{background:var(--card);border-radius:12px;padding:1.5rem;margin-top:1.5rem}
  .lb-entry{display:flex;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid #1c2436;color:#ffffff}
  .lb-entry:last-child{border-bottom:none}
  .difficulty-select{margin-bottom:1.5rem}
  .diff-btn{margin:0 .5rem;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;border:2px solid #1c2436;background:var(--panel);color:#ffffff}
  .diff-btn.active{border-color:var(--accent);background:linear-gradient(145deg,#8bd5ff,var(--accent));color:#0a1020}

  /* Animations */
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
  .bounce{animation:bounce .5s ease}
  .shake{animation:shake .5s ease}

  @media (max-width:940px){
    .sidebar{position:fixed; inset:0 auto 0 0; z-index:40; transform:translateX(-100%); transition:.2s ease}
    .sidebar.show{transform:none}
    .main{padding:16px}
    .toggleNav{position:fixed; top:12px; left:12px; z-index:50}
  }

  /* Additional styling for lists */
  ul{color:#ffffff}
  li{color:#ffffff; margin:.25rem 0}
  .pill{display:inline-block;padding:.12rem .5rem;border-radius:999px;background:#18223c;color:#ffffff;margin-right:.25rem}
  .viz{height:10px;background:#1a2746;border-radius:999px;position:relative;overflow:hidden;margin-top:.35rem}
  .viz>span{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,var(--accent),#8bd5ff);width:0%}
</style>
</head>
<body>
  <button class="btn toggleNav" type="button" onclick="toggleNav()" aria-label="Toggle navigation">☰</button>
  <aside class="sidebar" id="nav" aria-label="Lesson navigation">
    <div class="brand"><span class="dot" aria-hidden="true"></span><h1>FIN 311 • Ch.9 Financial Manager & Markets</h1></div>
    <div class="tablist" role="tablist">
      <button class="tabbtn active" role="tab" aria-selected="true" onclick="showTab('review')">📘 Review</button>
      <button class="tabbtn" role="tab" aria-selected="false" onclick="showTab('qcards')">🧠 Q-cards</button>
      <button class="tabbtn" role="tab" aria-selected="false" onclick="showTab('mcqs')">📝 MCQs</button>
      <button class="tabbtn" role="tab" aria-selected="false" onclick="showTab('shorts')">✍️ Short Questions</button>
      <button class="tabbtn" role="tab" aria-selected="false" onclick="showTab('game')">🎮 Markets Challenge</button>
      <div class="small" style="margin-top:10px">
        Master financial markets and corporate finance fundamentals through interactive challenges.
      </div>
    </div>
  </aside>

  <main class="main">
    <!-- REVIEW -->
    <section id="review" class="tabcontent active" role="tabpanel">
      <div class="hero">
        <h2>Chapter 9 — Financial Manager & Markets</h2>
        <div class="muted">Core financial management concepts, market structures, and trading mechanics.</div>
        <div style="margin-top:10px">
          <span class="chip">Goal of Firm</span><span class="chip">Agency Problems</span><span class="chip">Primary vs Secondary</span><span class="chip">Money vs Capital</span>
          <span class="chip">Broker vs Dealer</span><span class="chip">Order Types</span><span class="chip">Underwriting</span>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="panel">
          <h3>1) Core concepts</h3>
          <ul>
            <li><strong>Goal of the firm:</strong> Maximize the value of owners' equity (shareholder wealth). Value reflects timing, risk, and size of cash flows.</li>
            <li><strong>Financial manager's 3 jobs:</strong> <span class="pill">Capital budgeting</span> (which projects), <span class="pill">Financing</span> (debt vs equity), <span class="pill">Working capital</span> (cash, receivables, payables, inventory).</li>
            <li><strong>Agency problem:</strong> Managers may chase perks/empire size vs value. Fixes: value-tied pay (ROIC/TSR), independent board/audit, debt & covenants, market discipline.</li>
          </ul>
        </div>

        <div class="panel">
          <h3>2) Markets map</h3>
          <ul>
            <li><strong>Primary vs secondary:</strong> Primary = issuer sells new securities (cash to issuer). Secondary = investor-to-investor trading.</li>
            <li><strong>Money vs capital:</strong> Money ≤1y (T-Bills, CP). Capital >1y (bonds, stocks).</li>
            <li><strong>Broker vs dealer:</strong> Broker = agent (commission). Dealer = principal; quotes bid/ask; earns spread.</li>
            <li><strong>Venues & regs (CA):</strong> Exchanges/OTC; CSA & provincial commissions; IIROC.</li>
          </ul>
        </div>

        <div class="panel">
          <h3>3) Orders & execution</h3>
          <ul>
            <li><strong>Market:</strong> execution certainty, price uncertain.</li>
            <li><strong>Limit:</strong> price certainty, fill not guaranteed.</li>
            <li><strong>Stop (stop-loss):</strong> becomes market order when stop is hit.</li>
            <li><strong>Stop-limit:</strong> triggers a limit—may not execute.</li>
            <li><strong>Explicit vs implicit costs:</strong> commissions/fees vs spread, impact, timing, opportunity cost.</li>
          </ul>
        </div>

        <div class="panel">
          <h3>4) Mini tool — Bid–Ask calculator</h3>
          <div style="display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; margin:8px 0">
            <label style="color:#ffffff">Bid <input id="bid" type="number" step="0.01" value="24.90"></label>
            <label style="color:#ffffff">Ask <input id="ask" type="number" step="0.01" value="25.10"></label>
            <label style="color:#ffffff">Qty <input id="qty" type="number" step="100" value="1000"></label>
            <button class="btn" onclick="calcSpread9()">Compute</button>
          </div>
          <p id="spreadOut" class="muted small">Enter bid < ask and quantity.</p>
          <div class="viz" id="spreadViz"><span></span></div>
        </div>
      </div>
    </section>

    <!-- Q-CARDS -->
    <section id="qcards" class="tabcontent" role="tabpanel" aria-hidden="true">
      <div class="panel">
        <h3>Flip Q-cards — Chapter 9 core terms</h3>
        <div class="cards">
          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Primary financial objective?</strong></div>
            <div class="face back">Maximize firm value (PV of owners' future free cash flows).</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>3 decisions of finance?</strong></div>
            <div class="face back">Investing (projects), Financing (debt/equity), Working capital (short-term ops).</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Agency problem & fixes</strong></div>
            <div class="face back">Misaligned manager/owner incentives → tie pay to value (ROIC/TSR), independent board/audit, covenants.</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Primary vs secondary</strong></div>
            <div class="face back">Primary = new issue; cash to issuer. Secondary = investor-to-investor.</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Money vs capital</strong></div>
            <div class="face back">Money ≤1y (T-Bills, CP). Capital >1y (bonds, stocks).</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Broker vs dealer</strong></div>
            <div class="face back">Broker = agent (commission). Dealer = principal; quotes bid/ask; earns spread.</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Order types</strong></div>
            <div class="face back">Market, Limit, Stop (market on trigger), Stop-limit (limit on trigger).</div>
          </div></div>

          <div class="qcard"><div class="q-inner">
            <div class="face"><strong>Underwriting types</strong></div>
            <div class="face back">Firm-commitment/bought deal vs Best-efforts.</div>
          </div></div>
        </div>
      </div>
    </section>

    <!-- MCQS -->
    <section id="mcqs" class="tabcontent" role="tabpanel" aria-hidden="true">
      <div class="panel">
        <h3>MCQs — Financial Manager & Markets</h3>

        <div class="mcq">
          <h4>1) The primary financial goal of a firm is to:</h4>
          <label class="opt"><input type="radio" name="q1"> Maximize current-year accounting profit</label>
          <label class="opt" data-correct="1"><input type="radio" name="q1"> Maximize firm value (PV of future cash flows)</label>
          <label class="opt"><input type="radio" name="q1"> Minimize leverage</label>
          <div class="explain">Value = PV of future cash flows (timing+risk matter).</div>
        </div>

        <div class="mcq">
          <h4>2) Issuer sells new securities to investors. This is the:</h4>
          <label class="opt" data-correct="1"><input type="radio" name="q2"> Primary market</label>
          <label class="opt"><input type="radio" name="q2"> Secondary market</label>
          <label class="opt"><input type="radio" name="q2"> Money market</label>
          <div class="explain">Primary market = new issue; cash to issuer.</div>
        </div>

        <div class="mcq">
          <h4>3) A 3-month T-Bill trades in the:</h4>
          <label class="opt" data-correct="1"><input type="radio" name="q3"> Money market</label>
          <label class="opt"><input type="radio" name="q3"> Capital market</label>
          <label class="opt"><input type="radio" name="q3"> FX market</label>
          <div class="explain">Money market = securities ≤1 year maturity.</div>
        </div>

        <div class="mcq">
          <h4>4) Who quotes bid/ask from inventory?</h4>
          <label class="opt"><input type="radio" name="q4"> Broker</label>
          <label class="opt" data-correct="1"><input type="radio" name="q4"> Dealer/market-maker</label>
          <label class="opt"><input type="radio" name="q4"> Custodian</label>
          <div class="explain">Dealers quote prices from their inventory and act as principals.</div>
        </div>

        <div class="mcq">
          <h4>5) Order to buy only if price ≤ 50.20:</h4>
          <label class="opt" data-correct="1"><input type="radio" name="q5"> Limit buy at 50.20</label>
          <label class="opt"><input type="radio" name="q5"> Market buy</label>
          <label class="opt"><input type="radio" name="q5"> Stop-limit sell 50.20</label>
          <div class="explain">Limit buy executes at or below the limit only.</div>
        </div>
      </div>
    </section>

    <!-- SHORT QUESTIONS -->
    <section id="shorts" class="tabcontent" role="tabpanel" aria-hidden="true">
      <div class="panel">
        <h3>Short Questions — applied scenarios</h3>

        <details><summary><strong>Firm-commitment vs best-efforts underwriting—pros/cons for issuer?</strong></summary>
          <div class="solve">
            <strong>Firm-commitment/bought deal:</strong> Underwriter buys issue and resells; issuer gets price/time certainty & immediate funds; pays higher fee; bank bears price risk.
            <br><br>
            <strong>Best-efforts:</strong> Bank only places the issue; lower fees possible but less certainty—issuer bears price/placement risk.
          </div>
        </details>

        <details><summary><strong>What does the greenshoe (overallotment) option do?</strong></summary>
          <div class="solve">
            Lets underwriters sell ~15% extra shares to stabilize prices post-offering; covers short if demand is strong, or supports price via buybacks.
          </div>
        </details>

        <details><summary><strong>Three implicit trading costs and a way to mitigate each.</strong></summary>
          <div class="solve">
            <strong>Spread</strong> → use limit orders/liquid venues.<br>
            <strong>Market impact</strong> → slice orders / VWAP/POV algos.<br>
            <strong>Timing risk</strong> → avoid volatile windows; stage execution.
          </div>
        </details>

        <details><summary><strong>Compute "money left on the table": Offer $20, 2.0M shares, close $22.</strong></summary>
          <div class="solve">
            <strong>$4,000,000</strong> = (22−20)×2,000,000.
          </div>
        </details>
      </div>
    </section>

    <!-- SPEED CHALLENGE GAME -->
    <section id="game" class="tabcontent" role="tabpanel" aria-hidden="true">
      <div class="panel">
        <h1>🎮 Financial Markets Challenge</h1>
        <p class="muted">Test your knowledge of financial markets, trading, and corporate finance fundamentals!</p>
        
        <div class="game-arena">
          <!-- Game Start Screen -->
          <div id="game-start" class="game-over">
            <h2>🏦 Ready to Master Financial Markets?</h2>
            <div class="difficulty-select">
              <h3>Choose Your Trading Level:</h3>
              <button class="diff-btn active" data-diff="easy">Rookie Trader<br><small>14s per question</small></button>
              <button class="diff-btn" data-diff="medium">Market Pro<br><small>10s per question</small></button>
              <button class="diff-btn" data-diff="hard">Wall Street<br><small>7s per question</small></button>
            </div>
            <button class="btn" onclick="startGame()">🚀 Start Trading</button>
            
            <!-- Leaderboard -->
            <div class="leaderboard">
              <h3>🏆 Trading Hall of Fame</h3>
              <div id="leaderboard-list">
                <div class="lb-entry"><span>No trades yet!</span><span>Be the first to trade!</span></div>
              </div>
            </div>
          </div>

          <!-- Game Stats -->
          <div id="game-stats" class="game-stats" style="display:none">
            <div class="stat-card">
              <div class="stat-value" id="score">0</div>
              <div class="stat-label">Score</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="streak">0</div>
              <div class="stat-label">Streak</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="correct">0</div>
              <div class="stat-label">Correct</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="remaining">12</div>
              <div class="stat-label">Remaining</div>
            </div>
          </div>

          <!-- Question Card -->
          <div id="question-container" style="display:none">
            <div class="timer-bar">
              <div class="timer-fill" id="timer-fill"></div>
            </div>
            
            <div class="question-card" id="question-card">
              <div class="streak-indicator" id="streak-display" style="display:none">🔥 Streak: <span id="streak-num">0</span></div>
              <div class="question-text" id="question-text"></div>
              <div class="answer-options" id="answer-options"></div>
            </div>
            
            <button class="btn ghost" onclick="skipQuestion()">Skip Question</button>
          </div>

          <!-- Game Over Screen -->
          <div id="game-over" class="game-over" style="display:none">
            <h2>📈 Trading Session Complete!</h2>
            <div class="final-score" id="final-score">0</div>
            <div class="performance">
              <div class="perf-item">✅ Profitable: <strong id="final-correct">0</strong></div>
              <div class="perf-item">❌ Losses: <strong id="final-wrong">0</strong></div>
              <div class="perf-item">🔥 Best Run: <strong id="final-streak">0</strong></div>
              <div class="perf-item">⚡ Avg Time: <strong id="avg-time">0s</strong></div>
            </div>
            <div class="performance-message" id="performance-msg"></div>
            <button class="btn" onclick="resetGame()">🔄 New Session</button>
            <button class="btn ghost" onclick="showLeaderboard()">📊 Leaderboard</button>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
  function toggleNav(){ document.getElementById('nav').classList.toggle('show'); }
  function showTab(id){
    document.querySelectorAll('.tabbtn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
    document.querySelectorAll('.tabcontent').forEach(s=>{ s.classList.remove('active'); s.setAttribute('aria-hidden','true'); });
    document.querySelector('[onclick="showTab(\''+id+'\')"]').classList.add('active');
    document.querySelector('[onclick="showTab(\''+id+'\')"]').setAttribute('aria-selected','true');
    document.getElementById(id).classList.add('active');
    document.getElementById(id).setAttribute('aria-hidden','false');
    if(innerWidth<940) document.getElementById('nav').classList.remove('show');
  }

  // MCQ interactions
  document.querySelectorAll('.mcq').forEach(block=>{
    block.querySelectorAll('.opt').forEach(opt=>{
      opt.addEventListener('click',()=>{
        block.querySelectorAll('.opt').forEach(o=>{ o.classList.remove('correct','wrong'); });
        if(opt.dataset.correct==='1'){ opt.classList.add('correct'); } else { opt.classList.add('wrong'); }
        block.querySelector('.explain').style.display='block';
      });
    });
  });

  // Difficulty buttons
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // Financial Markets Speed Challenge Game
  let gameState = {
    score: 0,
    streak: 0,
    bestStreak: 0,
    correct: 0,
    wrong: 0,
    currentQuestion: 0,
    totalQuestions: 12,
    difficulty: 'easy',
    timer: null,
    timeLeft: 14,
    questionStartTime: 0,
    responseTimes: []
  };

  const difficulties = {
    easy: { time: 14, scoreMultiplier: 1, streakBonus: 12 },
    medium: { time: 10, scoreMultiplier: 1.4, streakBonus: 18 },
    hard: { time: 7, scoreMultiplier: 2, streakBonus: 25 }
  };

  // Financial Markets Question bank - covering Ch9 concepts
  const questions = [
    {
      text: "The primary goal of financial management is to:",
      answers: ["Maximize revenue", "Maximize firm value", "Minimize costs", "Maximize market share"],
      correct: 1,
      explanation: "Financial managers should maximize shareholder wealth (firm value)"
    },
    {
      text: "Bid $24.90, Ask $25.10. What's the spread?",
      answers: ["$0.20", "$0.30", "$0.10", "$0.40"],
      correct: 0,
      explanation: "Spread = Ask - Bid = $25.10 - $24.90 = $0.20"
    },
    {
      text: "A 6-month Treasury Bill trades in which market?",
      answers: ["Capital market", "Money market", "Foreign exchange", "Derivative market"],
      correct: 1,
      explanation: "Securities ≤1 year maturity trade in money markets"
    },
    {
      text: "Who acts as principal and quotes bid/ask prices?",
      answers: ["Broker", "Dealer", "Agent", "Custodian"],
      correct: 1,
      explanation: "Dealers quote prices from their inventory and act as principals"
    },
    {
      text: "Order type that guarantees execution but not price:",
      answers: ["Limit order", "Market order", "Stop order", "Stop-limit order"],
      correct: 1,
      explanation: "Market orders execute immediately at best available price"
    },
    {
      text: "In firm-commitment underwriting, who bears the price risk?",
      answers: ["Issuer", "Underwriter", "Investors", "Exchange"],
      correct: 1,
      explanation: "Underwriter buys entire issue, bearing price/inventory risk"
    },
    {
      text: "Primary market involves:",
      answers: ["Investor-to-investor trading", "New securities issuance", "Market making", "Arbitrage trading"],
      correct: 1,
      explanation: "Primary market = new securities from issuer to investors"
    },
    {
      text: "Rights offering typically:",
      answers: ["Raises price above market", "Offers shares at discount to existing holders", "Eliminates all dilution", "Requires SEC approval only"],
      correct: 1,
      explanation: "Rights give existing shareholders option to buy new shares at discount"
    },
    {
      text: "Which is an implicit trading cost?",
      answers: ["Commission", "Bid-ask spread", "Exchange fees", "Regulatory fees"],
      correct: 1,
      explanation: "Bid-ask spread is implicit cost; commissions are explicit"
    },
    {
      text: "Stop order becomes a market order when:",
      answers: ["Market opens", "Stop price is hit", "Volume increases", "Day ends"],
      correct: 1,
      explanation: "Stop orders trigger into market orders when stop price is touched"
    },
    {
      text: "IPO underpricing refers to:",
      answers: ["Offer price below book value", "First-day close above offer", "Low demand for shares", "Underwriter losses"],
      correct: 1,
      explanation: "Underpricing = first-day trading price exceeds offer price"
    },
    {
      text: "Best way to align manager and shareholder interests:",
      answers: ["Fixed salary", "Revenue-based bonus", "Equity compensation tied to long-term value", "Perks and benefits"],
      correct: 2,
      explanation: "Equity-based pay aligns managers with shareholder value creation"
    }
  ];

  function startGame() {
    const selectedDiff = document.querySelector('.diff-btn.active').dataset.diff;
    gameState.difficulty = selectedDiff;
    gameState.timeLeft = difficulties[selectedDiff].time;
    
    // Reset game state
    gameState.score = 0;
    gameState.streak = 0;
    gameState.bestStreak = 0;
    gameState.correct = 0;
    gameState.wrong = 0;
    gameState.currentQuestion = 0;
    gameState.responseTimes = [];
    
    // Shuffle questions
    gameState.questions = [...questions].sort(() => Math.random() - 0.5).slice(0, gameState.totalQuestions);
    
    // Show game UI
    document.getElementById('game-start').style.display = 'none';
    document.getElementById('game-stats').style.display = 'grid';
    document.getElementById('question-container').style.display = 'block';
    
    updateStats();
    showNextQuestion();
  }

  function updateStats() {
    document.getElementById('score').textContent = gameState.score.toLocaleString();
    document.getElementById('streak').textContent = gameState.streak;
    document.getElementById('correct').textContent = gameState.correct;
    document.getElementById('remaining').textContent = gameState.totalQuestions - gameState.currentQuestion;
  }

  function showNextQuestion() {
    if (gameState.currentQuestion >= gameState.totalQuestions) {
      endGame();
      return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    const questionCard = document.getElementById('question-card');
    
    // Reset card styling
    questionCard.className = 'question-card';
    
    // Set question text
    document.getElementById('question-text').textContent = question.text;
    
    // Create answer options
    const optionsContainer = document.getElementById('answer-options');
    optionsContainer.innerHTML = '';
    
    question.answers.forEach((answer, index) => {
      const button = document.createElement('button');
      button.className = 'answer-btn';
      button.textContent = answer;
      button.onclick = () => selectAnswer(index);
      optionsContainer.appendChild(button);
    });
    
    // Update streak display
    const streakDisplay = document.getElementById('streak-display');
    if (gameState.streak > 0) {
      streakDisplay.style.display = 'block';
      document.getElementById('streak-num').textContent = gameState.streak;
    } else {
      streakDisplay.style.display = 'none';
    }
    
    // Start timer
    startTimer();
    gameState.questionStartTime = Date.now();
  }

  function startTimer() {
    gameState.timeLeft = difficulties[gameState.difficulty].time;
    updateTimerBar();
    
    gameState.timer = setInterval(() => {
      gameState.timeLeft--;
      updateTimerBar();
      
      if (gameState.timeLeft <= 0) {
        clearInterval(gameState.timer);
        selectAnswer(-1); // Time up = wrong answer
      }
    }, 1000);
  }

  function updateTimerBar() {
    const maxTime = difficulties[gameState.difficulty].time;
    const percentage = (gameState.timeLeft / maxTime) * 100;
    document.getElementById('timer-fill').style.width = percentage + '%';
  }

  function selectAnswer(selectedIndex) {
    clearInterval(gameState.timer);
    
    const responseTime = (Date.now() - gameState.questionStartTime) / 1000;
    gameState.responseTimes.push(responseTime);
    
    const question = gameState.questions[gameState.currentQuestion];
    const isCorrect = selectedIndex === question.correct;
    const questionCard = document.getElementById('question-card');
    const answerButtons = document.querySelectorAll('.answer-btn');
    
    // Disable all buttons
    answerButtons.forEach(btn => btn.onclick = null);
    
    // Show correct answer
    answerButtons.forEach((btn, index) => {
      if (index === question.correct) {
        btn.classList.add('correct');
      } else if (index === selectedIndex && !isCorrect) {
        btn.classList.add('wrong');
      }
    });
    
    if (isCorrect) {
      gameState.correct++;
      gameState.streak++;
      gameState.bestStreak = Math.max(gameState.bestStreak, gameState.streak);
      
      // Calculate score - Markets theme: knowledge + speed
      const basePoints = 100;
      const timeBonus = Math.floor(gameState.timeLeft * 6);
      const streakBonus = gameState.streak * difficulties[gameState.difficulty].streakBonus;
      const difficultyMultiplier = difficulties[gameState.difficulty].scoreMultiplier;
      
      const points = Math.floor((basePoints + timeBonus + streakBonus) * difficultyMultiplier);
      gameState.score += points;
      
      questionCard.classList.add('correct');
      questionCard.classList.add('bounce');
      
    } else {
      gameState.wrong++;
      gameState.streak = 0;
      questionCard.classList.add('wrong');
      questionCard.classList.add('shake');
    }
    
    gameState.currentQuestion++;
    updateStats();
    
    // Show next question after delay
    setTimeout(() => {
      questionCard.classList.remove('bounce', 'shake');
      showNextQuestion();
    }, 2000);
  }

  function skipQuestion() {
    selectAnswer(-1); // Treat skip as wrong answer
  }

  function endGame() {
    // Hide game UI
    document.getElementById('game-stats').style.display = 'none';
    document.getElementById('question-container').style.display = 'none';
    
    // Show results
    const gameOver = document.getElementById('game-over');
    gameOver.style.display = 'block';
    
    document.getElementById('final-score').textContent = gameState.score.toLocaleString();
    document.getElementById('final-correct').textContent = gameState.correct;
    document.getElementById('final-wrong').textContent = gameState.wrong;
    document.getElementById('final-streak').textContent = gameState.bestStreak;
    
    const avgTime = gameState.responseTimes.length > 0 
      ? (gameState.responseTimes.reduce((a, b) => a + b, 0) / gameState.responseTimes.length).toFixed(1)
      : '0';
    document.getElementById('avg-time').textContent = avgTime + 's';
    
    // Performance message - Markets themed
    const accuracy = (gameState.correct / gameState.totalQuestions) * 100;
    let message = '';
    if (accuracy >= 90) message = '🏆 Market Master! You understand financial markets inside out!';
    else if (accuracy >= 80) message = '📈 Expert Trader! You have solid market knowledge!';
    else if (accuracy >= 70) message = '💼 Good Analyst! Review order types and market structure.';
    else if (accuracy >= 60) message = '📚 Keep Learning! Focus on primary vs secondary markets.';
    else message = '🎯 Practice Mode! Study the fundamentals and try again!';
    
    document.getElementById('performance-msg').innerHTML = message;
    
    // Save to leaderboard
    saveScore();
  }

  function resetGame() {
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('game-start').style.display = 'block';
    loadLeaderboard();
  }

  function saveScore() {
    const scores = JSON.parse(localStorage.getItem('ch9_scores') || '[]');
    const newScore = {
      score: gameState.score,
      difficulty: gameState.difficulty,
      accuracy: Math.round((gameState.correct / gameState.totalQuestions) * 100),
      avgTime: gameState.responseTimes.length > 0 ? 
        (gameState.responseTimes.reduce((a, b) => a + b, 0) / gameState.responseTimes.length).toFixed(1) : '0',
      date: new Date().toLocaleDateString()
    };
    
    scores.push(newScore);
    scores.sort((a, b) => b.score - a.score);
    scores.splice(5); // Keep top 5
    
    localStorage.setItem('ch9_scores', JSON.stringify(scores));
    loadLeaderboard();
  }

  function loadLeaderboard() {
    const scores = JSON.parse(localStorage.getItem('ch9_scores') || '[]');
    const leaderboard = document.getElementById('leaderboard-list');
    
    if (scores.length === 0) {
      leaderboard.innerHTML = '<div class="lb-entry"><span>No trades yet!</span><span>Be the first to trade!</span></div>';
      return;
    }
    
    leaderboard.innerHTML = scores.map((score, index) => `
      <div class="lb-entry">
        <span>#${index + 1} • ${score.score.toLocaleString()} pts (${score.accuracy}% in ${score.avgTime}s)</span>
        <span>${score.difficulty.toUpperCase()} • ${score.date}</span>
      </div>
    `).join('');
  }

  function showLeaderboard() {
    resetGame();
  }

  // Initialize leaderboard on page load
  loadLeaderboard();

  // Bid-ask calculator
  function calcSpread9(){
    const bid=parseFloat(document.getElementById('bid').value||0);
    const ask=parseFloat(document.getElementById('ask').value||0);
    const qty=parseInt(document.getElementById('qty').value||0,10);
    const out=document.getElementById('spreadOut');
    if(!(bid>0&&ask>0&&ask>bid&&qty>0)){out.textContent='Enter valid bid<ask and quantity.';return;}
    const spread=ask-bid, mid=(ask+bid)/2, pct=spread/mid*100, rtc=spread*qty;
    out.innerHTML=`Spread = <b>$${spread.toFixed(2)}</b> • Mid = $${mid.toFixed(2)} • %Spread ≈ <b>${pct.toFixed(2)}%</b>
    <br>Approx. round-trip cost for ${qty.toLocaleString()} shares: <b>$${rtc.toFixed(2)}</b>`;
    document.querySelector('#spreadViz>span').style.width=Math.min(pct*2,100)+'%';
  }
</script>
</body>
</html>